<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trippin' - Trip History</title>
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body>
    <div class="container">
        <header class="section">
            <h1>Trip History</h1>
            <nav>
                <a href="home.html" class="button">Back to Home</a>
            </nav>
        </header>

        <h2 class="section-title">Past Trips</h2>
        
        <!-- Section for Manager Approval Completed Trips -->
        <section class="section">
            <h2 class="section-title">Manager Approval Completed</h2>
            <ul id="completedTripsList">
                <p id="noCompletedTripsMessage">Loading...</p>
            </ul>
        </section>

        <!-- Section for Pending Manager Approval Trips -->
        <section class="section">
            <h2 class="section-title">Pending Manager Approval</h2>
            <ul id="pendingTripsList">
                <p id="noPendingTripsMessage">Loading...</p>
            </ul>
        </section>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const userId = new URLSearchParams(window.location.search).get('user_id');

            if (!userId) {
                const message = document.getElementById('noPastTripsMessage');
                message.textContent = "User ID is missing. Unable to load trips.";
                return;
            }

            fetch(`../backend/fetch_history_trips.php?user_id=${userId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to fetch trips.");
                    }
                    return response.json();
                })
                .then(async trips => {
                    const completedTripsList = document.getElementById('completedTripsList');
                    const pendingTripsList = document.getElementById('pendingTripsList');
                    const noCompletedTripsMessage = document.getElementById('noCompletedTripsMessage');
                    const noPendingTripsMessage = document.getElementById('noPendingTripsMessage');

                    // Filter trips into categories
                    const completedTrips = trips.filter(trip => trip.status === 2);
                    const pendingTrips = trips.filter(trip => trip.status === 1);

                    // Render completed trips
                    if (completedTrips.length === 0) {
                        noCompletedTripsMessage.textContent = "No completed trips to display.";
                    } else {
                        noCompletedTripsMessage.style.display = "none";
                        const completedTripElements = await Promise.all(
                            completedTrips.map(async trip => {
                                const expenses = await fetchExpenses(trip.id);
                                return `
                                    <li class="trip-item">
                                        <h3>${trip.destination}</h3>
                                        <p>Date: ${new Date(trip.start_date).toLocaleDateString()} - ${new Date(trip.end_date).toLocaleDateString()}</p>
                                        <p>Status: Manager Approval Completed</p>
                                        <h4>Expenses:</h4>
                                        <ul>
                                            ${expenses.map(expense => `
                                                <li>
                                                    Reason: ${expense.reason}, 
                                                    Amount: ${expense.amount} ${expense.currency}, 
                                                    Date: ${new Date(expense.date).toLocaleDateString()},
                                                    Status: ${expense.status}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </li>
                                `;
                            })
                        );
                        completedTripsList.innerHTML = completedTripElements.join('');
                    }

                    // Render pending trips
                    if (pendingTrips.length === 0) {
                        noPendingTripsMessage.textContent = "No pending trips to display.";
                    } else {
                        noPendingTripsMessage.style.display = "none";
                        const pendingTripElements = pendingTrips.map(trip => `
                            <li class="trip-item">
                                <h3>${trip.destination}</h3>
                                <p>Date: ${new Date(trip.start_date).toLocaleDateString()} - ${new Date(trip.end_date).toLocaleDateString()}</p>
                                <p>Status: Pending Manager Approval</p>
                            </li>
                        `);
                        pendingTripsList.innerHTML = pendingTripElements.join('');
                    }
                })
                .catch(err => {
                    console.error("Error loading trip history:", err);
                    const message = document.getElementById('noPastTripsMessage');
                    message.textContent = "Failed to load trip history.";
                });
        });

        async function fetchExpenses(tripId) {
            const response = await fetch(`../backend/fetch_expenses.php?trip_id=${tripId}`);
            if (!response.ok) {
                console.error(`Failed to fetch expenses for trip ${tripId}`);
                return [];
            }
            return await response.json();
        }
    </script>
</body>
</html>